<!DOCTYPE html>
<html lang="ja" class="light">
<head>
    <meta charset="UTF-8">
    <link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192x192.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>Polandball Story Maker</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts & Material Symbols -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />

    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        m3: {
                            primary: 'var(--md-sys-color-primary)',
                            onPrimary: 'var(--md-sys-color-on-primary)',
                            primaryContainer: 'var(--md-sys-color-primary-container)',
                            onPrimaryContainer: 'var(--md-sys-color-on-primary-container)',
                            secondary: 'var(--md-sys-color-secondary)',
                            onSecondary: 'var(--md-sys-color-on-secondary)',
                            secondaryContainer: 'var(--md-sys-color-secondary-container)',
                            onSecondaryContainer: 'var(--md-sys-color-on-secondary-container)',
                            surface: 'var(--md-sys-color-surface)',
                            onSurface: 'var(--md-sys-color-on-surface)',
                            surfaceVariant: 'var(--md-sys-color-surface-variant)',
                            onSurfaceVariant: 'var(--md-sys-color-on-surface-variant)',
                            outline: 'var(--md-sys-color-outline)',
                            background: 'var(--md-sys-color-background)',
                            onBackground: 'var(--md-sys-color-on-background)',
                        }
                    },
                    fontFamily: {
                        sans: ['Noto Sans JP', 'Roboto', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            /* M3 Light Theme Tokens (Blue/Neutral based) */
            --md-sys-color-primary: #005FAF;
            --md-sys-color-on-primary: #FFFFFF;
            --md-sys-color-primary-container: #D4E3FF;
            --md-sys-color-on-primary-container: #001C3A;
            --md-sys-color-secondary: #545F71;
            --md-sys-color-on-secondary: #FFFFFF;
            --md-sys-color-secondary-container: #D8E3F8;
            --md-sys-color-on-secondary-container: #111C2B;
            --md-sys-color-surface: #F8F9FF;
            --md-sys-color-on-surface: #191C20;
            --md-sys-color-surface-variant: #E0E2EC;
            --md-sys-color-on-surface-variant: #43474E;
            --md-sys-color-outline: #74777F;
            --md-sys-color-background: #F8F9FF;
            --md-sys-color-on-background: #191C20;
        }

        .dark {
            /* M3 Dark Theme Tokens */
            --md-sys-color-primary: #A5C8FF;
            --md-sys-color-on-primary: #00315F;
            --md-sys-color-primary-container: #004786;
            --md-sys-color-on-primary-container: #D4E3FF;
            --md-sys-color-secondary: #BCC7DC;
            --md-sys-color-on-secondary: #263141;
            --md-sys-color-secondary-container: #3C4758;
            --md-sys-color-on-secondary-container: #D8E3F8;
            --md-sys-color-surface: #111318;
            --md-sys-color-on-surface: #E1E2E8;
            --md-sys-color-surface-variant: #43474E;
            --md-sys-color-on-surface-variant: #C4C6D0;
            --md-sys-color-outline: #8E9099;
            --md-sys-color-background: #111318;
            --md-sys-color-on-background: #E1E2E8;
        }

        body {
            background-color: var(--md-sys-color-background);
            color: var(--md-sys-color-on-background);
            transition: background-color 0.3s, color 0.3s;
        }

        /* Material Ripple effect helper */
        .ripple {
            position: relative;
            overflow: hidden;
        }
        .ripple::after {
            content: "";
            display: block;
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            background-image: radial-gradient(circle, #000 10%, transparent 10.01%);
            background-repeat: no-repeat;
            background-position: 50%;
            transform: scale(10, 10);
            opacity: 0;
            transition: transform .5s, opacity 1s;
        }
        .ripple:active::after {
            transform: scale(0, 0);
            opacity: 0.1;
            transition: 0s;
        }

        /* Scrollbar hiding for clean UI */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .story-bubble-container {
            opacity: 0;
            transform: translateY(20px);
            animation: popIn 0.3s forwards ease-out;
        }

        @keyframes popIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden flex flex-col font-sans select-none">

    <!-- App Bar -->
    <header class="h-16 flex items-center justify-between px-4 bg-m3-surface text-m3-onSurface z-10 sticky top-0">
        <div class="flex items-center gap-3">
            <span class="material-symbols-outlined text-3xl text-m3-primary">public</span>
            <h1 class="text-xl font-bold tracking-tight">Polandball Maker</h1>
        </div>
        <div id="loading-indicator" class="hidden">
            <span class="material-symbols-outlined animate-spin text-m3-primary">refresh</span>
        </div>
    </header>

    <!-- Main Content Area -->
    <main id="main-content" class="flex-1 overflow-y-auto relative bg-m3-background p-4 pb-24">
        
        <!-- HOME TAB -->
        <div id="tab-home" class="tab-content flex flex-col gap-6 max-w-2xl mx-auto">
            <!-- Daily Column Card -->
            <div id="daily-column" class="bg-m3-secondaryContainer text-m3-onSecondaryContainer rounded-3xl p-6 shadow-sm hidden">
                <div class="flex justify-between items-start mb-2">
                    <h2 class="text-lg font-bold flex items-center gap-2">
                        <span class="material-symbols-outlined">calendar_month</span>
                        On This Day
                    </h2>
                    <span id="current-date" class="text-sm opacity-70"></span>
                </div>
                <p id="historical-event" class="text-base leading-relaxed"></p>
                <div class="mt-4 flex justify-end">
                    <button onclick="useEventAsPrompt()" class="text-sm font-medium underline opacity-80 hover:opacity-100">これをもとに物語を作る</button>
                </div>
            </div>

            <!-- Creation Form -->
            <div class="bg-m3-surfaceVariant text-m3-onSurfaceVariant rounded-3xl p-6 shadow-sm">
                <h2 class="text-2xl font-bold mb-4 text-m3-onSurface">物語を作る</h2>
                <div class="flex flex-col gap-4">
                    <div>
                        <label class="block text-xs font-bold mb-1 uppercase tracking-wider opacity-70">時代 / 年代</label>
                        <input type="text" id="input-era" placeholder="例: 1945年、冷戦時代、ローマ帝国..." class="w-full bg-m3-surface text-m3-onSurface rounded-xl px-4 py-3 outline-none border border-transparent focus:border-m3-primary transition-colors">
                    </div>
                    <div>
                        <label class="block text-xs font-bold mb-1 uppercase tracking-wider opacity-70">ジャンル / テーマ</label>
                        <input type="text" id="input-theme" placeholder="例: 宇宙開発競争、平和条約、日常..." class="w-full bg-m3-surface text-m3-onSurface rounded-xl px-4 py-3 outline-none border border-transparent focus:border-m3-primary transition-colors">
                    </div>
                    
                    <button onclick="generateStory()" class="ripple mt-2 bg-m3-primary text-m3-onPrimary rounded-full py-4 px-6 font-bold shadow-md hover:shadow-lg active:scale-95 transition-all flex justify-center items-center gap-2">
                        <span class="material-symbols-outlined">auto_awesome</span>
                        生成する
                    </button>
                </div>
            </div>
            
            <div class="text-center opacity-60 text-sm mt-4">
                <p>Gemini 2.5 Flash が歴史に基づいたコミカルな脚本を書きます。</p>
            </div>
        </div>

        <!-- STORY TAB -->
        <div id="tab-story" class="tab-content hidden max-w-2xl mx-auto h-full flex flex-col">
            <div id="story-container" class="flex-1 flex flex-col gap-4 pb-4">
                <!-- Chat bubbles will be injected here -->
                <div class="flex flex-col items-center justify-center h-full text-m3-outline opacity-50">
                    <span class="material-symbols-outlined text-6xl mb-2">forum</span>
                    <p>物語はまだありません</p>
                </div>
            </div>
            
            <!-- Player Controls -->
            <div id="story-controls" class="hidden fixed bottom-24 left-1/2 -translate-x-1/2 bg-m3-surfaceVariant/90 backdrop-blur-md p-2 rounded-full shadow-lg flex items-center gap-2 z-20 border border-m3-outline/20">
                <button onclick="toggleTTS()" id="btn-tts" class="p-3 rounded-full hover:bg-white/10 transition-colors text-m3-onSurfaceVariant">
                    <span class="material-symbols-outlined">play_arrow</span>
                </button>
                <div class="h-4 w-[1px] bg-m3-outline opacity-30"></div>
                <button onclick="saveCurrentStory()" class="p-3 rounded-full hover:bg-white/10 transition-colors text-m3-onSurfaceVariant" title="保存">
                    <span class="material-symbols-outlined">save</span>
                </button>
                <button onclick="clearStoryView()" class="p-3 rounded-full hover:bg-white/10 transition-colors text-m3-onSurfaceVariant" title="クリア">
                    <span class="material-symbols-outlined">delete</span>
                </button>
            </div>
        </div>

        <!-- LOG TAB -->
        <div id="tab-log" class="tab-content hidden max-w-2xl mx-auto">
            <h2 class="text-2xl font-bold mb-6 text-m3-onSurface px-2">保存された物語</h2>
            <div id="log-list" class="flex flex-col gap-3">
                <!-- Logs will be here -->
            </div>
        </div>

        <!-- SETTINGS TAB -->
        <div id="tab-settings" class="tab-content hidden max-w-2xl mx-auto">
            <h2 class="text-2xl font-bold mb-6 text-m3-onSurface px-2">設定</h2>
            
            <div class="bg-m3-surfaceVariant rounded-2xl overflow-hidden mb-6">
                <!-- API Key -->
                <div class="p-4 border-b border-m3-outline/20">
                    <label class="block text-sm font-medium mb-2 text-m3-onSurfaceVariant">Gemini API Key</label>
                    <div class="flex gap-2">
                        <input type="password" id="api-key-input" class="flex-1 bg-m3-surface text-m3-onSurface rounded-lg px-3 py-2 outline-none" placeholder="APIキーを入力">
                        <button onclick="saveSettings()" class="bg-m3-primary text-m3-onPrimary px-4 py-2 rounded-lg text-sm font-bold">保存</button>
                    </div>
                    <p class="text-xs mt-2 opacity-60">※キーはブラウザにのみ保存されます。</p>
                </div>

                <!-- Dark Mode -->
                <div class="p-4 flex items-center justify-between border-b border-m3-outline/20 cursor-pointer hover:bg-black/5" onclick="toggleDarkMode()">
                    <div class="flex items-center gap-3">
                        <span class="material-symbols-outlined text-m3-onSurfaceVariant">dark_mode</span>
                        <span>ダークモード</span>
                    </div>
                    <div id="toggle-dark" class="w-10 h-6 bg-m3-outline rounded-full relative transition-colors">
                        <div class="absolute top-1 left-1 w-4 h-4 bg-white rounded-full transition-transform"></div>
                    </div>
                </div>

                <!-- Daily Column -->
                <div class="p-4 flex items-center justify-between cursor-pointer hover:bg-black/5" onclick="toggleDailyColumn()">
                    <div class="flex items-center gap-3">
                        <span class="material-symbols-outlined text-m3-onSurfaceVariant">newspaper</span>
                        <span>毎日のコラムを表示</span>
                    </div>
                    <div id="toggle-column" class="w-10 h-6 bg-m3-primary rounded-full relative transition-colors">
                        <div class="absolute top-1 right-1 w-4 h-4 bg-white rounded-full transition-transform"></div>
                    </div>
                </div>
            </div>
            
            <div class="px-2">
                 <h3 class="text-sm font-bold opacity-70 mb-2">収録キャラクター</h3>
                 <div id="char-preview" class="flex flex-wrap gap-2">
                     <!-- Icons populated via JS -->
                 </div>
            </div>
        </div>

    </main>

    <!-- Navigation Bar -->
    <nav class="h-20 bg-m3-surfaceContainer text-m3-onSurfaceVariant flex justify-around items-center border-t border-m3-outline/10 z-20">
        <button onclick="switchTab('home')" class="nav-btn group flex flex-col items-center gap-1 w-16" data-target="home">
            <div class="icon-container px-4 py-1 rounded-full group-hover:bg-m3-onSurfaceVariant/10 transition-colors">
                <span class="material-symbols-outlined fill-current text-2xl">home</span>
            </div>
            <span class="text-xs font-medium">Home</span>
        </button>
        <button onclick="switchTab('story')" class="nav-btn group flex flex-col items-center gap-1 w-16" data-target="story">
            <div class="icon-container px-4 py-1 rounded-full group-hover:bg-m3-onSurfaceVariant/10 transition-colors">
                <span class="material-symbols-outlined text-2xl">auto_stories</span>
            </div>
            <span class="text-xs font-medium">Story</span>
        </button>
        <button onclick="switchTab('log')" class="nav-btn group flex flex-col items-center gap-1 w-16" data-target="log">
            <div class="icon-container px-4 py-1 rounded-full group-hover:bg-m3-onSurfaceVariant/10 transition-colors">
                <span class="material-symbols-outlined text-2xl">history</span>
            </div>
            <span class="text-xs font-medium">Log</span>
        </button>
        <button onclick="switchTab('settings')" class="nav-btn group flex flex-col items-center gap-1 w-16" data-target="settings">
            <div class="icon-container px-4 py-1 rounded-full group-hover:bg-m3-onSurfaceVariant/10 transition-colors">
                <span class="material-symbols-outlined text-2xl">settings</span>
            </div>
            <span class="text-xs font-medium">Config</span>
        </button>
    </nav>

    <!-- Scripts -->
    <script>
        /**
         * 1. Data & Config
         */
        
        // Character Data from user request
        const characterMap = {
            "Argentina": "https://cdn.polandball.wiki/gco/b/ba/Argentina-icon.png",
            "Brazil": "https://cdn.polandball.wiki/gco/4/4c/Brazil-icon.png",
            "Japan": "https://cdn.polandball.wiki/gco/e/e3/Japan-icon.png",
            "Mexico": "https://cdn.polandball.wiki/gco/a/a3/Mexico-icon.png",
            "Poland": "https://cdn.polandball.wiki/gco/0/01/Polandball-icon.png",
            "Spain": "https://cdn.polandball.wiki/gco/7/76/Spain-icon.png",
            "UK": "https://cdn.polandball.wiki/gco/b/be/UK-icon.png",
            "United Kingdom": "https://cdn.polandball.wiki/gco/b/be/UK-icon.png",
            "Scotland": "https://cdn.polandball.wiki/gco/3/3e/Scotland-icon.png",
            "USA": "https://cdn.polandball.wiki/gco/6/6c/USA-icon.png",
            "America": "https://cdn.polandball.wiki/gco/6/6c/USA-icon.png",
            "United States": "https://cdn.polandball.wiki/gco/6/6c/USA-icon.png",
            "Iraq": "https://cdn.polandball.wiki/gco/2/23/Iraq-icon.png",
            "Netherlands": "https://cdn.polandball.wiki/gco/4/45/Netherlands-icon.png",
            "Germany": "https://cdn.polandball.wiki/gco/b/ba/Germany-icon.png",
            "Italy": "https://cdn.polandball.wiki/gco/7/7d/Italy-icon.png",
            "Portugal": "https://cdn.polandball.wiki/gco/e/ed/Portugal-icon.png",
            "Russia": "https://cdn.polandball.wiki/gco/8/81/Russia-icon.png",
            "USSR": "https://cdn.polandball.wiki/gco/8/81/Russia-icon.png", // Fallback visually
            "Soviet Union": "https://cdn.polandball.wiki/gco/8/81/Russia-icon.png",
            "HRE": "https://cdn.polandball.wiki/gco/3/3c/HRE-icon.png",
            "Holy Roman Empire": "https://cdn.polandball.wiki/gco/3/3c/HRE-icon.png",
            "France": "https://cdn.polandball.wiki/gco/c/c5/France-icon.png", // Adding common ones that might be missing but useful fallback or guess
            "China": "https://cdn.polandball.wiki/gco/6/65/China-icon.png",
            "Unknown": "https://cdn.polandball.wiki/gco/1/14/404-icon.png"
        };

        const state = {
            currentTab: 'home',
            apiKey: localStorage.getItem('pb_api_key') || '',
            darkMode: localStorage.getItem('pb_dark_mode') === 'true',
            showColumn: localStorage.getItem('pb_show_column') !== 'false', // Default true
            currentStory: [],
            logs: JSON.parse(localStorage.getItem('pb_logs') || '[]'),
            isPlaying: false,
            speechSynthesis: window.speechSynthesis,
            utterance: null
        };

        // Simple Historical Events DB for "On This Day" (Mock for demonstration)
        const historicalEvents = [
            { month: 1, day: 1, event: "1863年 - リンカーンが奴隷解放宣言を発布。" },
            { month: 7, day: 4, event: "1776年 - アメリカ独立宣言が採択される。" },
            { month: 7, day: 14, event: "1789年 - バスティーユ襲撃。フランス革命の勃発。" },
            { month: 8, day: 15, event: "1945年 - 日本で玉音放送。第二次世界大戦終結。" },
            { month: 12, day: 25, event: "800年 - カール大帝がローマ皇帝として戴冠。" },
            // Fallback generic
            { month: 0, day: 0, event: "1969年 - アポロ11号が月面着陸に成功（7月20日）。" }
        ];

        /**
         * 2. Initialization & UI Logic
         */
        window.onload = () => {
            // Apply Settings
            if (state.darkMode) document.documentElement.classList.add('dark');
            document.getElementById('api-key-input').value = state.apiKey;
            updateSettingsUI();
            
            // Render Character Preview in Settings
            renderCharPreview();
            
            // Setup Daily Column
            setupDailyColumn();

            // Load Logs
            renderLogs();
            
            // Init Tab
            switchTab('home');
        };

        function updateSettingsUI() {
            // Dark Mode Toggle
            const toggleDark = document.getElementById('toggle-dark');
            const dotDark = toggleDark.querySelector('div');
            if (state.darkMode) {
                toggleDark.className = "w-10 h-6 bg-m3-primary rounded-full relative transition-colors";
                dotDark.className = "absolute top-1 right-1 w-4 h-4 bg-white rounded-full transition-transform";
            } else {
                toggleDark.className = "w-10 h-6 bg-m3-outline rounded-full relative transition-colors";
                dotDark.className = "absolute top-1 left-1 w-4 h-4 bg-white rounded-full transition-transform";
            }

            // Column Toggle
            const toggleCol = document.getElementById('toggle-column');
            const dotCol = toggleCol.querySelector('div');
            const colCard = document.getElementById('daily-column');
            
            if (state.showColumn) {
                toggleCol.className = "w-10 h-6 bg-m3-primary rounded-full relative transition-colors";
                dotCol.className = "absolute top-1 right-1 w-4 h-4 bg-white rounded-full transition-transform";
                colCard.classList.remove('hidden');
            } else {
                toggleCol.className = "w-10 h-6 bg-m3-outline rounded-full relative transition-colors";
                dotCol.className = "absolute top-1 left-1 w-4 h-4 bg-white rounded-full transition-transform";
                colCard.classList.add('hidden');
            }
        }

        function switchTab(tabId) {
            // Hide all
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-btn').forEach(el => {
                const iconContainer = el.querySelector('.icon-container');
                iconContainer.classList.remove('bg-m3-secondaryContainer', 'text-m3-onSecondaryContainer');
                el.querySelector('.material-symbols-outlined').classList.remove('fill-current'); // filled icon logic
            });

            // Show target
            document.getElementById(`tab-${tabId}`).classList.remove('hidden');
            
            // Highlight Nav
            const btn = document.querySelector(`.nav-btn[data-target="${tabId}"]`);
            if(btn) {
                btn.querySelector('.icon-container').classList.add('bg-m3-secondaryContainer', 'text-m3-onSecondaryContainer');
            }

            state.currentTab = tabId;
        }

        function setupDailyColumn() {
            const date = new Date();
            const m = date.getMonth() + 1;
            const d = date.getDate();
            
            document.getElementById('current-date').innerText = `${m}月${d}日`;
            
            // Simple match or fallback
            const eventObj = historicalEvents.find(e => e.month === m && e.day === d) || 
                             historicalEvents[Math.floor(Math.random() * historicalEvents.length)];
            
            document.getElementById('historical-event').innerText = eventObj.event;
        }

        function useEventAsPrompt() {
            const txt = document.getElementById('historical-event').innerText;
            document.getElementById('input-era').value = txt;
            document.getElementById('input-theme').value = "歴史的背景とifストーリー";
        }

        function renderCharPreview() {
            const container = document.getElementById('char-preview');
            // Filter uniques by URL to avoid duplicates in preview
            const uniqueUrls = new Set();
            
            Object.keys(characterMap).forEach(name => {
                const url = characterMap[name];
                if (!uniqueUrls.has(url)) {
                    uniqueUrls.add(url);
                    const img = document.createElement('img');
                    img.src = url;
                    img.title = name;
                    img.className = "w-8 h-8 rounded-full bg-white shadow-sm object-cover border border-gray-200";
                    container.appendChild(img);
                }
            });
        }

        /**
         * 3. Story Generation (Gemini API)
         */
        async function generateStory() {
            const era = document.getElementById('input-era').value;
            const theme = document.getElementById('input-theme').value;
            
            if (!era && !theme) {
                alert("時代かテーマを入力してください！");
                return;
            }
            if (!state.apiKey) {
                alert("設定タブでAPIキーを入力してください！");
                switchTab('settings');
                return;
            }

            // UI Loading
            document.getElementById('loading-indicator').classList.remove('hidden');
            const generateBtn = document.querySelector('button[onclick="generateStory()"]');
            const originalBtnText = generateBtn.innerHTML;
            generateBtn.innerHTML = '<span class="material-symbols-outlined animate-spin">refresh</span> 生成中...';
            generateBtn.disabled = true;

            const availableChars = Object.keys(characterMap).join(', ');

            const systemPrompt = `
            あなたは歴史ジョーク漫画「ポーランドボール（カントリーボール）」の日本語の脚本家です。
            以下の条件でJSON形式のスクリプトを作成してください。

            1. **キャラクター**: 歴史的な国や現代の国が登場します。以下のリストにある国名を優先的に使用してください: [${availableChars}]。リストにない場合は一般的な英語の国名を使用してください。
            2. **特徴**:
日本語で出力しますが、ポーランドボール特有の口調（「〜なんよ」「〜おぶ」など）を使ってください。
            3. **フォーマット**:
               必ず以下のJSON配列のみを出力してください。Markdown記法は不要です。
               [
                 {"character": "CountryName", "text": "Dialogue content here."},
                 {"character": "CountryName2", "text": "Response here."}
               ]

            **入力テーマ**:
            時代: ${era}
            テーマ: ${theme}
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${state.apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: systemPrompt }] }]
                    })
                });

                if (!response.ok) throw new Error("API Request Failed");

                const data = await response.json();
                let rawText = data.candidates[0].content.parts[0].text;
                
                // Cleanup JSON formatting (remove markdown code blocks if Gemini adds them)
                rawText = rawText.replace(/```json/g, '').replace(/```/g, '').trim();
                
                const storyJson = JSON.parse(rawText);
                
                // Success
                state.currentStory = storyJson;
                renderChat(storyJson);
                switchTab('story');
                document.getElementById('story-controls').classList.remove('hidden');

            } catch (e) {
                console.error(e);
                alert("生成に失敗しました。APIキーまたはネットワークを確認してください。\nError: " + e.message);
            } finally {
                document.getElementById('loading-indicator').classList.add('hidden');
                generateBtn.innerHTML = originalBtnText;
                generateBtn.disabled = false;
            }
        }

        /**
         * 4. Chat Rendering Logic
         */
        function renderChat(storyData) {
            const container = document.getElementById('story-container');
            container.innerHTML = '';
            
            // Add Spacer at top
            const spacer = document.createElement('div');
            spacer.className = "h-4";
            container.appendChild(spacer);

            let isLeft = true;
            let lastChar = "";

            storyData.forEach((line, index) => {
                // Determine layout side (switch side if character changes, but keep predictable)
                // For simplicity: Alternate sides or strict assignment logic could be used.
                // Let's do: User input logic is hard here, so we just alternate groups.
                if (line.character !== lastChar) {
                    isLeft = !isLeft;
                    lastChar = line.character;
                }
                
                // Get Icon
                let iconUrl = characterMap[line.character] || characterMap["Unknown"];
                // Try fuzzy match if exact match fail
                if (!characterMap[line.character]) {
                    const found = Object.keys(characterMap).find(k => line.character.includes(k) || k.includes(line.character));
                    if(found) iconUrl = characterMap[found];
                }

                const bubbleRow = document.createElement('div');
                bubbleRow.className = `w-full flex ${isLeft ? 'justify-start' : 'justify-end'} mb-4 px-2 story-bubble-container`;
                bubbleRow.style.animationDelay = `${index * 0.1}s`;

                const contentHtml = `
                    <div class="flex gap-2 max-w-[80%] ${isLeft ? 'flex-row' : 'flex-row-reverse'}">
                        <div class="flex-shrink-0 flex flex-col items-center gap-1">
                            <img src="${iconUrl}" alt="${line.character}" class="w-10 h-10 rounded-full bg-white border border-gray-300 shadow-sm object-cover">
                            <span class="text-[10px] opacity-70 truncate max-w-[50px]">${line.character}</span>
                        </div>
                        <div class="flex flex-col ${isLeft ? 'items-start' : 'items-end'}">
                            <div class="${isLeft ? 'bg-m3-surfaceVariant text-m3-onSurfaceVariant rounded-tl-none' : 'bg-m3-primaryContainer text-m3-onPrimaryContainer rounded-tr-none'} p-3 rounded-2xl shadow-sm text-sm leading-relaxed">
                                ${marked.parse(line.text)}
                            </div>
                        </div>
                    </div>
                `;

                bubbleRow.innerHTML = contentHtml;
                container.appendChild(bubbleRow);
            });
            
            // Scroll to bottom
            setTimeout(() => {
                const main = document.getElementById('main-content');
                main.scrollTo({ top: main.scrollHeight, behavior: 'smooth' });
            }, 100);
        }

        function clearStoryView() {
            if(confirm("画面をクリアしますか？")) {
                document.getElementById('story-container').innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-m3-outline opacity-50">
                    <span class="material-symbols-outlined text-6xl mb-2">forum</span>
                    <p>物語はまだありません</p>
                </div>`;
                state.currentStory = [];
                document.getElementById('story-controls').classList.add('hidden');
                stopTTS();
            }
        }

        /**
         * 5. Logging & Storage
         */
        function saveCurrentStory() {
            if (state.currentStory.length === 0) return;
            
            const title = state.currentStory[0].character + "の話 (" + new Date().toLocaleString() + ")";
            const logEntry = {
                id: Date.now(),
                title: title,
                data: state.currentStory
            };
            
            state.logs.unshift(logEntry);
            localStorage.setItem('pb_logs', JSON.stringify(state.logs));
            renderLogs();
            alert("物語をログに保存しました！");
        }

        function renderLogs() {
            const list = document.getElementById('log-list');
            list.innerHTML = '';
            
            if (state.logs.length === 0) {
                list.innerHTML = '<p class="text-center opacity-50 p-4">保存された物語はありません</p>';
                return;
            }

            state.logs.forEach(log => {
                const item = document.createElement('div');
                item.className = "bg-m3-surface text-m3-onSurface p-4 rounded-xl shadow-sm flex justify-between items-center border border-m3-outline/10";
                item.innerHTML = `
                    <div class="truncate pr-4 cursor-pointer flex-1" onclick="loadLog(${log.id})">
                        <h3 class="font-bold text-sm truncate">${log.title}</h3>
                        <p class="text-xs opacity-60">${new Date(log.id).toLocaleDateString()} - ${log.data.length} lines</p>
                    </div>
                    <button onclick="deleteLog(${log.id})" class="p-2 text-m3-error opacity-50 hover:opacity-100">
                        <span class="material-symbols-outlined">delete</span>
                    </button>
                `;
                list.appendChild(item);
            });
        }

        window.loadLog = (id) => {
            const log = state.logs.find(l => l.id === id);
            if (log) {
                state.currentStory = log.data;
                renderChat(log.data);
                switchTab('story');
                document.getElementById('story-controls').classList.remove('hidden');
            }
        };

        window.deleteLog = (id) => {
            if (confirm("削除しますか？")) {
                state.logs = state.logs.filter(l => l.id !== id);
                localStorage.setItem('pb_logs', JSON.stringify(state.logs));
                renderLogs();
            }
        };

        /**
         * 6. TTS (Podcast Mode)
         */
        function toggleTTS() {
            const btn = document.getElementById('btn-tts');
            const icon = btn.querySelector('span');
            
            if (state.isPlaying) {
                stopTTS();
                icon.innerText = "play_arrow";
            } else {
                startTTS();
                icon.innerText = "stop";
            }
            state.isPlaying = !state.isPlaying;
        }

        function startTTS() {
            if (state.currentStory.length === 0) return;
            
            // Cancel any current speaking
            state.speechSynthesis.cancel();

            let fullText = "";
            state.currentStory.forEach(line => {
                // Adjusting speed/pitch based on character could be added here
                // but standard reading is safer for browser compatibility
                fullText += `${line.character}が言いました。「${line.text}」 \n`;
            });

            state.utterance = new SpeechSynthesisUtterance(fullText);
            state.utterance.lang = 'ja-JP';
            state.utterance.rate = 1.0;
            state.utterance.pitch = 1.0;
            
            state.utterance.onend = () => {
                state.isPlaying = false;
                document.getElementById('btn-tts').querySelector('span').innerText = "play_arrow";
            };

            state.speechSynthesis.speak(state.utterance);
        }

        function stopTTS() {
            state.speechSynthesis.cancel();
        }

        /**
         * 7. Settings Handlers
         */
        function saveSettings() {
            const key = document.getElementById('api-key-input').value;
            state.apiKey = key;
            localStorage.setItem('pb_api_key', key);
            alert("設定を保存しました。");
        }

        function toggleDarkMode() {
            state.darkMode = !state.darkMode;
            if (state.darkMode) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            localStorage.setItem('pb_dark_mode', state.darkMode);
            updateSettingsUI();
        }

        function toggleDailyColumn() {
            state.showColumn = !state.showColumn;
            localStorage.setItem('pb_show_column', state.showColumn);
            updateSettingsUI();
        }

    </script>
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js')
        .then((registration) => {
          console.log('Service Worker registered with scope:', registration.scope);
        })
        .catch((error) => {
          console.error('Service Worker registration failed:', error);
        });
    });
  }
</script>
</body>
</html>
